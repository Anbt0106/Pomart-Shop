{% extends "layout_admin.html" %}

{% block content %}

<div class="admin-content">
    <div class="admin-header">
        <h1>Sửa sản phẩm</h1>
        <div class="admin-actions">
            <a href="{{ url_for('admin.add_item') }}" class="btn btn-primary">
                <i class="fa-solid fa-plus"></i> Thêm sản phẩm
            </a>
        </div>
    </div>

    <div class="admin-add_product">
        <form method="POST" enctype="multipart/form-data">

            <div class="form-group">
                {{ form.name.label(class="form-control-label")}}
                {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                {% for error in form.name.errors %}
                <div class="invalid-feedback">
                    {{ error }}
                </div>
                {% endfor %}
            </div>

            <div class="form-group">
                {{ form.description.label(class="form-control-label")}}
                {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows=4)
                }}
                {% for error in form.description.errors %}
                <div class="invalid-feedback">
                    {{ error }}
                </div>
                {% endfor %}
            </div>

            <div class="box-form-group mb-3">

                <div class="form-group">
                    {{ form.price.label(class="form-control-label")}}
                    {{ form.price(class="form-control" + (" is-invalid" if form.price.errors else "")) }}
                    {% for error in form.price.errors %}
                    <div class="invalid-feedback">
                        {{ error }}
                    </div>
                    {% endfor %}
                </div>

                <div class="form-group">
                    {{ form.stock.label(class="form-control-label")}}
                    {{ form.stock(class="form-control" + (" is-invalid" if form.stock.errors else "")) }}
                    {% for error in form.stock.errors %}
                    <div class="invalid-feedback">
                        {{ error }}
                    </div>
                    {% endfor %}
                </div>
                <div class="form-group">
                    {{ form.date_released.label(class="form-label fw-bold") }}
                    {{ form.date_released(class="form-control" + (" is-invalid" if form.date_released.errors else ""))
                    }}
                    {% for error in form.date_released.errors %}
                    <div class="invalid-feedback">
                        {{ error }}
                    </div>
                    {% endfor %}
                </div>
                <div class="form-group">
                    {{ form.collection.label(class="form-label fw-bold") }}
                    {{ form.collection(class="form-control" + (" is-invalid" if form.collection.errors else ""),
                    list="collection-list") }}
                    <datalist id="collection-list">
                        {% for name in collection_names %}
                        <option value="{{ name }}">
                            {% endfor %}
                    </datalist>
                    {% for error in form.collection.errors %}
                    <div class="invalid-feedback">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>


            <div class="form-group">
                {{ form.image.label(class="form-label fw-bold") }}
                <div class="image-upload-wrapper">
                    <!-- Existing images -->
                    <div id="existing-images" class="image-previews-container mb-3">
                        {% for image in existing_images %}
                        <div class="preview-image-wrapper" data-image-id="{{ image.id }}">
                            <img src="{{ url_for('static', filename='img/products/' + image.image_url) }}"
                                 class="img-thumbnail" alt="Product image">
                            <button type="button" class="remove-image-btn"
                                    onclick="deleteImage({{ image.id }}, '{{ image.image_url }}')">×</button>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Upload new images -->
                    <div class="image-upload-box">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Kéo và thả ảnh vào đây, hoặc bấm để chọn</p>
                        {{ form.image(class="form-control-file" + (" is-invalid" if form.image.errors else ""),
                           multiple=True, id="imageUploadInput") }}
                    </div>
                    <div id="image-previews" class="image-previews-container mt-3"></div>
                </div>
                {% for error in form.image.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>

            <div class="form-group">
                <div class="form-check form-switch">
                    {{ form.is_active(class="form-check-input") }}
                    {{ form.is_active.label(class="form-check-label") }}
                </div>
            </div>

            <div class="form-group">
                <div class="form-check form-switch">
                    {{ form.is_featured(class="form-check-input") }}
                    {{ form.is_featured.label(class="form-check-label") }}
                </div>
            </div>

            <div class="btn-box">
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>

        <form method="POST" action="{{ url_for('admin.delete_item', product_id=item.id) }}"
              onsubmit="return confirm('Bạn có chắc chắn muốn xóa sản phẩm này?');"
              style="margin-top: 1rem;">
            <div class="btn-box">
                <button type="submit" class="btn btn-secondary">Delete</button>
            </div>
        </form>

    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadBox = document.querySelector('.image-upload-box');
    const imageInput = document.getElementById('imageUploadInput');
    const previewsContainer = document.getElementById('image-previews');

    let fileStore = new DataTransfer();

    // Handle file selection and preview creation
    function handleFiles(files) {
        for (const file of files) {
            if (file.type.startsWith('image/')) {
                let isDuplicate = false;
                for (let i = 0; i < fileStore.files.length; i++) {
                    if (fileStore.files[i].name === file.name &&
                        fileStore.files[i].size === file.size) {
                        isDuplicate = true;
                        break;
                    }
                }
                if (!isDuplicate) {
                    fileStore.items.add(file);
                    createPreview(file);
                }
            }
        }
        imageInput.files = fileStore.files;
    }

    // Create preview for new images
    function createPreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const wrapper = document.createElement('div');
            wrapper.classList.add('preview-image-wrapper');

            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('img-thumbnail');

            const removeBtn = document.createElement('button');
            removeBtn.classList.add('remove-image-btn');
            removeBtn.innerHTML = '×';
            removeBtn.type = 'button';

            removeBtn.addEventListener('click', function() {
                const newFileStore = new DataTransfer();
                for (let i = 0; i < fileStore.files.length; i++) {
                    if (fileStore.files[i].name !== file.name ||
                        fileStore.files[i].size !== file.size) {
                        newFileStore.items.add(fileStore.files[i]);
                    }
                }
                fileStore = newFileStore;
                imageInput.files = fileStore.files;
                wrapper.remove();
            });

            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            previewsContainer.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
    }

    // Delete existing image
    window.deleteImage = function(imageId, imageUrl) {
        if (confirm('Bạn có chắc chắn muốn xóa ảnh này?')) {
            fetch(`/admin/products/delete-image/${imageId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`[data-image-id="${imageId}"]`).remove();
                } else {
                    alert('Có lỗi khi xóa ảnh. Vui lòng thử lại.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi khi xóa ảnh. Vui lòng thử lại.');
            });
        }
    }

    // Event listeners for drag and drop
    imageInput.addEventListener('change', function() {
        handleFiles(this.files);
    });

    uploadBox.addEventListener('click', () => imageInput.click());

    uploadBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadBox.classList.add('dragover');
    });

    uploadBox.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadBox.classList.remove('dragover');
    });

    uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadBox.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });
});
</script>
{% endblock %}
