{% extends "layout.html" %}

{% block title %}Chi tiết đơn hàng #{{ order.id }} - Popmart{% endblock %}

{% block content %}
<div class="order-detail-page">
    <div class="grid">
    <div class="container">
        <div class="order-header">
            <div class="breadcrumb">
                <a href="{{ url_for('cart.my_orders') }}">← Quay lại đơn hàng của tôi</a>
            </div>
            <h1>Chi tiết đơn hàng #{{ order.id }}</h1>
        </div>

        <div class="order-info-grid">
            <!-- Order Status Card -->
            <div class="info-card">
                <h3>Trạng thái đơn hàng</h3>
                <div class="status-info">
                    <div class="status-item">
                        <span class="label">Trạng thái:</span>
                        <span class="status-badge {{ order.status }}">{{ order.status_display }}</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Thanh toán:</span>
                        <span class="payment-badge {{ order.payment_status }}">{{ order.payment_status_display }}</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Ngày đặt:</span>
                        <span>{{ order.placed_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                    {% if order.paid_at %}
                    <div class="status-item">
                        <span class="label">Ngày thanh toán:</span>
                        <span>{{ order.paid_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Shipping Address Card -->
            <div class="info-card">
                <h3>Địa chỉ giao hàng</h3>
                <div class="address-info">
                    <p><strong>{{ order.shipping_address.recipient_name }}</strong></p>
                    <p>{{ order.shipping_address.phone_number }}</p>
                    <p>{{ order.shipping_address.address }}</p>
                    <p>{{ order.shipping_address.city }}, {{ order.shipping_address.country }}</p>
                    {% if order.shipping_address.postal_code %}
                    <p>Mã bưu điện: {{ order.shipping_address.postal_code }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Payment Info Card -->
            <div class="info-card">
                <h3>Thông tin thanh toán</h3>
                <div class="payment-info">
                    {% for transaction in order.payment_transactions %}
                    <div class="payment-item">
                        <div class="payment-method">
                            <span class="label">Phương thức:</span>
                            <span>
                                {% if transaction.payment_method == 'cod' %}
                                    Thanh toán khi nhận hàng (COD)
                                {% elif transaction.payment_method == 'bank' %}
                                    Chuyển khoản ngân hàng
                                {% elif transaction.payment_method == 'momo' %}
                                    Ví MoMo
                                {% elif transaction.payment_method == 'zalopay' %}
                                    ZaloPay
                                {% else %}
                                    {{ transaction.payment_method }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="payment-status">
                            <span class="label">Trạng thái:</span>
                            <span class="payment-badge {{ transaction.status }}">
                                {% if transaction.status == 'pending' %}
                                    Đang xử lý
                                {% elif transaction.status == 'completed' %}
                                    Hoàn thành
                                {% elif transaction.status == 'failed' %}
                                    Thất bại
                                {% elif transaction.status == 'canceled' %}
                                    Đã hủy
                                {% else %}
                                    {{ transaction.status }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="order-items-section">
            <h3>Sản phẩm đã đặt</h3>
            <div class="items-list">
                {% for item in order.items %}
                <div class="order-item">
                    <div class="item-image">
                        {% if item.product.images %}
                            <img src="{{ url_for('static', filename='img/products/' + item.product.images[0].image_url) }}"
                                 alt="{{ item.product.name }}">
                        {% else %}
                            <img src="{{ url_for('static', filename='img/404.gif') }}"
                                 alt="No image">
                        {% endif %}
                    </div>
                    <div class="item-details">
                        <h4>{{ item.product.name }}</h4>
                        <p class="item-description">{{ item.product.description[:100] }}...</p>
                        <div class="item-meta">
                            <span>Số lượng: {{ item.quantity }}</span>
                            <span>Đơn giá: {{ "{:,.0f}".format(item.price) }} VND</span>
                        </div>
                    </div>
                    <div class="item-total">
                        <strong>{{ "{:,.0f}".format(item.subtotal) }} VND</strong>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Order Summary -->
        <div class="order-summary">
            <h3>Tóm tắt đơn hàng</h3>
            <div class="summary-details">
                <div class="summary-row">
                    <span>Tạm tính:</span>
                    <span>{{ "{:,.0f}".format(order.total_amount - (0 if order.total_amount >= 500000 else 30000)) }} VND</span>
                </div>

                {% if order.discount %}
                <div class="summary-row discount">
                    <span>Giảm giá ({{ order.discount.code }}):</span>
                    <span>-{{ "{:,.0f}".format(order.discount.calculate_discount(order.total_amount)) }} VND</span>
                </div>
                {% endif %}

                <div class="summary-row">
                    <span>Phí vận chuyển:</span>
                    <span>
                        {% if order.total_amount >= 500000 %}
                            Miễn phí
                        {% else %}
                            30,000 VND
                        {% endif %}
                    </span>
                </div>

                <div class="summary-row total">
                    <strong>Tổng cộng: {{ "{:,.0f}".format(order.total_amount) }} VND</strong>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="order-actions">
            {% if order.status == 'pending' and order.payment_status == 'unpaid' %}
            <form method="POST" action="{{ url_for('cart.cancel_order', order_id=order.id) }}" style="display: inline;">
                <button type="submit" class="btn btn-danger"
                        onclick="return confirm('Bạn có chắc muốn hủy đơn hàng này?')">
                    <i class="fas fa-times"></i> Hủy đơn hàng
                </button>
            </form>
            {% endif %}

            {% if order.status == 'delivered' %}
            <a href="{{ url_for('cart.reorder', order_id=order.id) }}" class="btn btn-primary">
                <i class="fas fa-redo"></i> Đặt lại đơn hàng
            </a>
            {% endif %}

            <a href="{{ url_for('cart.my_orders') }}" class="btn btn-secondary">
                <i class="fas fa-list"></i> Xem tất cả đơn hàng
            </a>
        </div>
    </div>
</div>
    </div>

<style>


.order-header {
    margin-bottom: 30px;
}

.breadcrumb a {
    color: #007bff;
    text-decoration: none;
    font-size: 14px;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.order-header h1 {
    margin: 10px 0 0 0;
    color: #333;
}

.order-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.info-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.info-card h3 {
    margin: 0 0 15px 0;
    color: #333;
    border-bottom: 2px solid #e74c3c;
    padding-bottom: 10px;
}

.status-info, .address-info, .payment-info {
    line-height: 1.6;
}

.status-item, .payment-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    align-items: center;
}

.label {
    font-weight: 500;
    color: #666;
}

.status-badge, .payment-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
}

.status-badge.pending {
    background: #fff3cd;
    color: #856404;
}

.status-badge.shipped {
    background: #d1ecf1;
    color: #0c5460;
}

.status-badge.delivered {
    background: #d4edda;
    color: #155724;
}

.status-badge.canceled {
    background: #f8d7da;
    color: #721c24;
}

.payment-badge.unpaid, .payment-badge.pending {
    background: #fff3cd;
    color: #856404;
}

.payment-badge.paid, .payment-badge.completed {
    background: #d4edda;
    color: #155724;
}

.payment-badge.failed {
    background: #f8d7da;
    color: #721c24;
}

.address-info p {
    margin: 5px 0;
    color: #333;
}

.order-items-section, .order-summary {
    background: white;
    margin-bottom: 20px;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.order-items-section h3, .order-summary h3 {
    margin: 0 0 20px 0;
    color: #333;
    border-bottom: 2px solid #e74c3c;
    padding-bottom: 10px;
}

.order-item {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.order-item:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.item-image img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 8px;
    margin-right: 20px;
}

.item-details {
    flex: 1;
}

.item-details h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 1.1rem;
}

.item-description {
    color: #666;
    margin: 5px 0 10px 0;
    font-size: 0.9rem;
}

.item-meta {
    display: flex;
    gap: 20px;
    font-size: 0.9rem;
    color: #666;
}

.item-total {
    font-size: 1.1rem;
    font-weight: bold;
    color: #e74c3c;
}

.summary-details {
    max-width: 400px;
    margin-left: auto;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 5px 0;
}

.summary-row.discount {
    color: #27ae60;
}

.summary-row.total {
    font-size: 1.2rem;
    padding-top: 15px;
    border-top: 2px solid #eee;
    margin-top: 15px;
}

.order-actions {
    text-align: center;
    margin-top: 30px;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    margin: 0 5px;
    border: none;
    border-radius: 5px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #e74c3c;
    color: white;
}

.btn-primary:hover {
    background: #c0392b;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

@media (max-width: 768px) {
    .order-info-grid {
        grid-template-columns: 1fr;
    }

    .order-item {
        flex-direction: column;
        text-align: center;
    }

    .item-image {
        margin-bottom: 15px;
    }

    .item-meta {
        justify-content: center;
    }

    .summary-details {
        max-width: 100%;
        margin: 0;
    }

    .order-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
}
</style>
{% endblock %}
